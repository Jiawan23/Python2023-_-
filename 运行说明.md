[toc]

# 运行说明

## 文件说明



![文件说明](.\markdown_image\文件说明.png)

## 操作说明

### 爬虫

直接运行crawler_Optimized.py即可。如果要从零开始爬取，可以先清空黑白名单和爬取日志中的文本，再运行爬虫代码。爬取的进度可由**tqdm**显示，用了**多线程加速**开20个线程从零爬取的时间大概为两个小时。需要爬取的信息包括电影的时长，imdb星级、users reviews数，Critic reviews数，计算电影导演的电影的平均星级。可以在process_html函数中修改添加要爬取的信息。爬取过程中请**确保网络稳定**，一轮爬取后，可以删除根据黑名单的信息在白名单和已经爬好的信息中删除因为网络不稳定导致（response为503）的爬取失败的样本，然后再次运行爬虫代码重复爬取。对于response为404的，可能由于电影本身的imdb编号错误或是有所迁移，可以手动搜索相关信息更改info.csv文件。此外，对于有缺失值的也可以手动搜索进行添加数据。爬虫代码运行结束后可以在archive文件夹中生成带colums的且按movieId排好序的爬取数据文件info.csv。

### 数据预处理

通过修改main中s.process_data的参数，可有两种预处理的方式，参数为1时得到的是用于分类问题的预处理数据（以'rating_class'即平均得分所属的类别作为标签），参数为其他值时（可设置为2）得到的是用于回归问题的预处理数据(以'rating'即平均得分作为标签)。此外，在process_film_ori方法中去掉处理Review的注释，并在process_data方法的最后修改文件保存路径，运行时可以得到带有经过**bert**模型处理后的review由文本转为多维数值的数据，不过经过测试，带有review时效果反而有所下降，这可能是由于爬取时未对文本进行更细致的处理，含有部分非英文的字符等原因导致的。代码中review的处理用了多线程加速，但由于本人电脑为集显，不能利用cuda加速，处理时间仍然较长，大约2个多小时，可以选择放在kaggle上利用其提供的P100的GPU进行加速处理，时间可缩短至大约一小时）。另外，由于film_ori.csv中的预算和三种票房数据都有大量的缺失项，可以在process_data方法中选择用中位数或是均值来填充缺失项，只需要，只需要在相应的处理位置注释掉一种处理的代码而保留另一种处理的代码即可。

### 模型训练与评估

一共有六种模型，分别为逻辑回归模型（实际是用于分类问题，对应model1），随机森林分类模型（对应model2和model2_optimized）、神经网络分类模型（对应model3），线性回归模型（对应model4）、随机森林回归模型（对应model5和model5_optimized）、神经网络回归模型（对应model6）。其中对于两种随机森林模型，采取贝叶斯优化调参。直接运行model.py文件即可查看模型训练与评估结果。如果需要单独查看某个或几个模型的训练与评估结果，只需要在main种注释掉其它模型的训练及评估对应的代码即可。若想取消贝叶斯优化调参的过程，以及取消加载神经网络模型的最佳参数，也只需要在main中注释掉相应的代码即可。注意随机森林输出的优化后的结果并不是经过贝叶斯优化后的最佳参数对应的结果，需要手动根据**贝叶斯优化调参**输出的最佳参数，在main中更改优化后的模型参数，再运行查看结果。而神经网络模型的评估默认是再最佳模型参数下进行的，若要查看当前设置的参数下的模型评估结果，请注释掉main中加载最佳模型参数对应的代码。若要查看神经网络训练过程的图形化展示，可以利用**TensorBoard**，首先打开终端或命令提示符（需要安装过tensorboard，建议在anaconda中对应的环境中安装并运行代码），运行`tensorboard --logdir=<directory_name>`,将directory_name替换为保存数据的目录（模型保存数据的文件夹为nn_runs，建议使用绝对路径），待TensorBoard成功上线后，用浏览器打开http://localhost:6006/ (即运行命令后给出的网址）即可查看模型的可视化训练结果。